<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>bikedata • bikedata</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="bikedata">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bikedata</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.2.1.99</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ropensci/bikedata">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>bikedata</h1>
                        <h4 class="author">Mark Padgham</h4>
            
            <h4 class="date">2018-09-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/bikedata/blob/master/vignettes/bikedata.Rmd"><code>vignettes/bikedata.Rmd</code></a></small>
      <div class="hidden name"><code>bikedata.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>1. Introduction</h2>
<p><code>bikedata</code> is an R package for downloading and aggregating data from public bicycle hire, or bike share, systems. Although there are very many public bicycle hire systems in the world (<a href="https://en.wikipedia.org/wiki/List_of_bicycle-sharing_systems">see this wikipedia list</a>), relatively few openly publish data on system usage. The <code>bikedata</code> package aims to enable ready importing of data from all systems which provide it, and will be expanded on an ongoing basis as more systems publish open data. Cities and names of associated public bicycle hire systems currently included in the <code>bikedata</code> package, along with numbers of bikes and of docking stations, are:</p>
<table class="table">
<thead><tr class="header">
<th>City</th>
<th>Hire Bicycle System</th>
<th>Number of Bicycles</th>
<th>Number of Docking Stations</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>London, U.K.</td>
<td><a href="https://tfl.gov.uk/modes/cycling/santander-cycles">Santander Cycles</a></td>
<td>13,600</td>
<td>839</td>
</tr>
<tr class="even">
<td>San Francisco Bay Area, U.S.A.</td>
<td><a href="https://www.fordgobike.com/">Ford GoBike</a></td>
<td>7,000</td>
<td>540</td>
</tr>
<tr class="odd">
<td>New York City NY, U.S.A.</td>
<td><a href="https://www.citibikenyc.com/">citibike</a></td>
<td>7,000</td>
<td>458</td>
</tr>
<tr class="even">
<td>Chicago IL, U.S.A.</td>
<td><a href="https://www.divvybikes.com/">Divvy</a></td>
<td>5,837</td>
<td>576</td>
</tr>
<tr class="odd">
<td>Montreal, Canada</td>
<td><a href="https://montreal.bixi.com/">Bixi</a></td>
<td>5,220</td>
<td>452</td>
</tr>
<tr class="even">
<td>Washingon DC, U.S.A.</td>
<td><a href="https://www.capitalbikeshare.com/">Capital BikeShare</a></td>
<td>4,457</td>
<td>406</td>
</tr>
<tr class="odd">
<td>Guadalajara, Mexico</td>
<td><a href="https://www.mibici.net/">mibici</a></td>
<td>2,116</td>
<td>242</td>
</tr>
<tr class="even">
<td>Minneapolis/St Paul MN, U.S.A.</td>
<td><a href="https://www.niceridemn.org/">Nice Ride</a></td>
<td>1,833</td>
<td>171</td>
</tr>
<tr class="odd">
<td>Boston MA, U.S.A.</td>
<td><a href="https://www.thehubway.com/">Hubway</a></td>
<td>1,461</td>
<td>158</td>
</tr>
<tr class="even">
<td>Philadelphia PA, U.S.A.</td>
<td><a href="https://www.rideindego.com">Indego</a></td>
<td>1,000</td>
<td>105</td>
</tr>
<tr class="odd">
<td>Los Angeles CA, U.S.A.</td>
<td><a href="https://bikeshare.metro.net/">Metro</a></td>
<td>1,000</td>
<td>65</td>
</tr>
</tbody>
</table>
<p>All of these systems record and disseminate individual trip data, minimally including the times and places at which every trip starts and ends. Some provide additional anonymised individual data, typically including whether or not a user is registered with the system and if so, additional data including age, gender, and residential postal code. The list of cities may be obtained with the <code><a href="../reference/bike_cities.html">bike_cities()</a></code> functions, and details of which include demographic data with <code><a href="../reference/bike_demographic_data.html">bike_demographic_data()</a></code>.</p>
<p>Cities with extensively developed systems and cultures of public hire bicycles, yet which do not provide (publicly available) data include:</p>
<table class="table">
<thead><tr class="header">
<th>City</th>
<th>Number of Bicycles</th>
<th>Number of Docking Stations</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Hangzhou, China</td>
<td>78,000</td>
<td>2,965</td>
</tr>
<tr class="even">
<td>Paris, France</td>
<td>14,500</td>
<td>1,229</td>
</tr>
<tr class="odd">
<td>Barcelona, Spain</td>
<td>6,000</td>
<td>424</td>
</tr>
</tbody>
</table>
<p>The current version of the <code>bikedata</code> R package can be installed with the following command:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">install.packages</span> (<span class="st">'bikedata'</span>)</a></code></pre></div>
<p>Or the development version with</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span> (<span class="st">"mpadge/bikedata"</span>)</a></code></pre></div>
<p>Once installed, it can be loaded in the usual way:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">library</span> (bikedata)</a></code></pre></div>
<pre><code>## Data for London, U.K. powered by TfL Open Data:
##   Contains OS data Ⓒ Crown copyright and database rights 2016
## Data for New York City provided and owned by:
##   NYC Bike Share, LLC and Jersey City Bike Share, LLC ("Bikeshare")
##   see https://www.citibikenyc.com/data-sharing-policy
## Data for Washington DC (Captialbikeshare), Chiago (Divvybikes) and Boston (Hubway)
##   provided and owned by Motivate International Inc.
##   see https://www.capitalbikeshare.com/data-license-agreement
##   and https://www.divvybikes.com/data-license-agreement
##   and https://www.thehubway.com/data-license-agreement
## Nice Ride Minnesota license  https://www.niceridemn.org/data_license</code></pre>
</div>
<div id="main-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#main-functions" class="anchor"></a>2. Main Functions</h2>
<p>The <code>bikedata</code> function <code><a href="../reference/dl_bikedata.html">dl_bikedata()</a></code> downloads individual trip data from any or all or the above listed systems, and the function <code><a href="../reference/store_bikedata.html">store_bikedata()</a></code> stores them in an <code>SQLite3</code> database. For example, the following line will download all data from the Metro system of Los Angeles CA, U.S.A., and store them in a database named ‘bikedb’,</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">bikedb &lt;-<span class="st"> </span><span class="kw">file.path</span> (<span class="kw">tempdir</span> (), <span class="st">"bikedb.sqlite"</span>) <span class="co"># or whatever</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw"><a href="../reference/dl_bikedata.html">dl_bikedata</a></span> (<span class="dt">city =</span> <span class="st">'la'</span>, <span class="dt">dates =</span> <span class="dv">2016</span>, <span class="dt">quiet =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="kw"><a href="../reference/store_bikedata.html">store_bikedata</a></span> (<span class="dt">data_dir =</span> <span class="kw">tempdir</span> (), <span class="dt">bikedb =</span> bikedb, <span class="dt">quiet =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## [1] 98138</code></pre>
<p>The <code><a href="../reference/store_bikedata.html">store_bikedata()</a></code> function returns the number of trips added to the database. Both the downloaded data and the <code>SQLite3</code> database are stored by default in the temporary directory of the current <code>R</code> session. Any data downloaded into <code>tempdir()</code> will of course be deleted on termination of the active <strong>R</strong> session; use of other directories (as described below) will create enduring data which must be managed by the user.</p>
<p>Successive calls to <code><a href="../reference/store_bikedata.html">store_bikedata()</a></code> will append additional data to the same database. For example, the following line will append all data from Chicago’s Divvy bike system from the year 2017 to the database created with the first call above.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="../reference/dl_bikedata.html">dl_bikedata</a></span> (<span class="dt">city =</span> <span class="st">'divvy'</span>, <span class="dt">dates =</span> <span class="dv">2016</span>, <span class="dt">quiet =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw"><a href="../reference/store_bikedata.html">store_bikedata</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">data_dir =</span> <span class="kw">tempdir</span> (), <span class="dt">quiet =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## [1] 3595383</code></pre>
<p>The function again returns the number of trips <em>added</em> to the database, which is now less than the total number of trips stored of:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw"><a href="../reference/bike_db_totals.html">bike_db_totals</a></span> (<span class="dt">bikedb =</span> bikedb)</a></code></pre></div>
<pre><code>## [1] 3693521</code></pre>
<p>Prior to accessing any data from the <code>SQLite3</code> database, it is recommended to create database indexes using the function <code><a href="../reference/index_bikedata_db.html">index_bikedata_db()</a></code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="../reference/index_bikedata_db.html">index_bikedata_db</a></span> (<span class="dt">bikedb =</span> bikedb)</a></code></pre></div>
<p>This will speed up subsequent extraction of aggregated data.</p>
<p>Having stored individual trip data in a database, the primary function of the <code>bikedata</code> package is <code><a href="../reference/bike_tripmat.html">bike_tripmat()</a></code>, which extracts aggregate numbers of trips between all pairs of stations. The minimal arguments to this function are the name of the database, and the name of a city for databases holding data from multiple cities.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">tm &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bike_tripmat.html">bike_tripmat</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">city =</span> <span class="st">'la'</span>)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="kw">class</span> (tm); <span class="kw">dim</span> (tm); <span class="kw">sum</span> (tm)</a></code></pre></div>
<pre><code>## [1] "matrix"</code></pre>
<pre><code>## [1] 64 64</code></pre>
<pre><code>## [1] 98138</code></pre>
<p>In 2016, the Los Angeles Metro system had 64 docking stations, and there were a total of 98,138 individual trips during the year. Trip matrices can also be extracted in long form using</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw"><a href="../reference/bike_tripmat.html">bike_tripmat</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">city =</span> <span class="st">'la'</span>, <span class="dt">long =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## # A tibble: 4,096 x 3
##    start_station_id end_station_id numtrips
##    &lt;chr&gt;            &lt;chr&gt;             &lt;dbl&gt;
##  1 la3005           la3005              252
##  2 la3005           la3006               93
##  3 la3005           la3007               23
##  4 la3005           la3008              153
##  5 la3005           la3010                5
##  6 la3005           la3011               63
##  7 la3005           la3014               40
##  8 la3005           la3016               10
##  9 la3005           la3018               31
## 10 la3005           la3019               36
## # ... with 4,086 more rows</code></pre>
<p>Details of the docking stations associated with these trip matrices can be obtained with</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw"><a href="../reference/bike_stations.html">bike_stations</a></span> (<span class="dt">bikedb =</span> bikedb)</a></code></pre></div>
<pre><code>## # A tibble: 660 x 6
##       id city  stn_id name  longitude latitude
##    &lt;int&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1     1 la    la3005 ""         34.0    -118.
##  2     2 la    la3006 ""         34.0    -118.
##  3     3 la    la3007 ""         34.1    -118.
##  4     4 la    la3008 ""         34.0    -118.
##  5     5 la    la3009 ""         34.0    -118.
##  6     6 la    la3010 ""         34.0    -118.
##  7     7 la    la3011 ""         34.0    -118.
##  8     8 la    la3013 ""         34.1    -118.
##  9     9 la    la3014 ""         34.1    -118.
## 10    10 la    la3016 ""         34.0    -118.
## # ... with 650 more rows</code></pre>
<p>Stations can also be extracted for particular cities:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">st &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bike_stations.html">bike_stations</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">city =</span> <span class="st">'ch'</span>)</a></code></pre></div>
<p>For consistency and to avoid potential confusion of function names, most functions in the <code>bikedata</code> package begin with the prefix <code>bike_</code> (except for <code><a href="../reference/store_bikedata.html">store_bikedata()</a></code> and <code><a href="../reference/dl_bikedata.html">dl_bikedata()</a></code>).</p>
<p>Databases generated by the <code>bikedata</code> package will generally be very large (commonly at least several GB), and many functions may take considerable time to execute. It is nevertheless possible to explore package functionality quickly through using the additional helper function, <code><a href="../reference/bike_write_test_data.html">bike_write_test_data()</a></code>. This function uses the <code>bike_dat</code> data set provided with the package, which contains details of 200 representative trips for each of the cities listed above. The function writes these data to disk as <code>.zip</code> files which can then be read by the <code><a href="../reference/store_bikedata.html">store_bikedata()</a></code> function.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="kw"><a href="../reference/bike_write_test_data.html">bike_write_test_data</a></span> ()</a>
<a class="sourceLine" id="cb21-2" data-line-number="2"><span class="kw"><a href="../reference/store_bikedata.html">store_bikedata</a></span> (<span class="dt">bikedb =</span> <span class="st">'testdb'</span>)</a>
<a class="sourceLine" id="cb21-3" data-line-number="3"><span class="kw"><a href="../reference/bike_summary_stats.html">bike_summary_stats</a></span> (<span class="dt">bikedb =</span> <span class="st">'testdb'</span>)</a></code></pre></div>
<p>The <code>.zip</code> files generated by <code><a href="../reference/bike_write_test_data.html">bike_write_test_data()</a></code> are created by default in the <code>tempdir()</code> of the current <code>R</code> session, and so will be deleted on session termination. Specifying any alternative <code>bike_dir</code> will create enduring copies of those files in that location which ought to be deleted when finished.</p>
<p>The remainder of this vignette provides further detail on these three distinct functional aspects of downloading, storage, and extraction of data.</p>
</div>
<div id="downloading-data" class="section level2">
<h2 class="hasAnchor">
<a href="#downloading-data" class="anchor"></a>3. Downloading Data</h2>
<p>Data may be downloaded with the <code><a href="../reference/dl_bikedata.html">dl_bikedata()</a></code> function. In it’s simplest form, this function requires specification only of a city for which data are to be downloaded, although the directory is usually specified as well:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="kw"><a href="../reference/dl_bikedata.html">dl_bikedata</a></span> (<span class="dt">city =</span> <span class="st">'chicago'</span>, <span class="dt">data_dir =</span> <span class="st">'/data/bikedata/'</span>)</a></code></pre></div>
</div>
<div id="downloading-data-for-specific-date-ranges" class="section level2">
<h2 class="hasAnchor">
<a href="#downloading-data-for-specific-date-ranges" class="anchor"></a>3.1 Downloading data for specific date ranges</h2>
<p>Both <code><a href="../reference/store_bikedata.html">store_bikedata()</a></code> and <code><a href="../reference/dl_bikedata.html">dl_bikedata()</a></code> accept an additional argument (<code>dates</code>) specifying ranges of dates for which data should be downloaded and stored. The format of this argument is quite flexible so that,</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw"><a href="../reference/dl_bikedata.html">dl_bikedata</a></span> (<span class="dt">city =</span> <span class="st">'dc'</span>, <span class="dt">dates =</span> <span class="dv">16</span>)</a></code></pre></div>
<p>will download data from Washington DC’s Capital Bikeshare system for all 12 months of the year 2016, while,</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="kw"><a href="../reference/dl_bikedata.html">dl_bikedata</a></span> (<span class="dt">city =</span> <span class="st">'ny'</span>, <span class="dt">dates =</span> <span class="dv">201604</span><span class="op">:</span><span class="dv">201608</span>)</a></code></pre></div>
<p>will download New York City data from April to August (inclusively) for that year. (Note that the default <code>data_dir</code> is the <code>tempdir()</code> of the current <code>R</code> session, with downloaded files being deleted upon session termination.) Dates can also be entered as character strings, with the following calls producing results equivalent to the preceding call,</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw"><a href="../reference/dl_bikedata.html">dl_bikedata</a></span> (<span class="dt">city =</span> <span class="st">'ny'</span>, <span class="dt">dates =</span> <span class="st">'2016/04:2016/08'</span>)</a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="kw"><a href="../reference/dl_bikedata.html">dl_bikedata</a></span> (<span class="dt">city =</span> <span class="st">'new york'</span>, <span class="dt">dates =</span> <span class="st">'201604:201608'</span>)</a>
<a class="sourceLine" id="cb25-3" data-line-number="3"><span class="kw"><a href="../reference/dl_bikedata.html">dl_bikedata</a></span> (<span class="dt">city =</span> <span class="st">'n.y.c.'</span>, <span class="dt">dates =</span> <span class="st">'2016-04:2016-08'</span>)</a>
<a class="sourceLine" id="cb25-4" data-line-number="4"><span class="kw"><a href="../reference/dl_bikedata.html">dl_bikedata</a></span> (<span class="dt">city =</span> <span class="st">'new'</span>, <span class="dt">dates =</span> <span class="st">'2016 Apr-Aug'</span>)</a></code></pre></div>
<p>The only strict requirement for the format of <code>dates</code> is that years must be specified before months, and that some kind of separator must be used between the two except when formatted as single six-digit numbers or character strings (YYYYMM). The arguments <code>city = 'new'</code> and <code>city = 'CI'</code> in the final call are sufficient to uniquely identify New York City’s citibike system.</p>
<p>If files have been previously downloaded to a nominated directory, then calling the <code><a href="../reference/dl_bikedata.html">dl_bikedata()</a></code> function will only download those data files that do not already exist. This function may thus be used to periodically refresh the contents of a nominated directory as new data files become available.</p>
<p>Some systems disseminate data on quarterly (Washington DC and Los Angeles) or bi-annual (Chicago) bases. The <code>dates</code> argument in these cases is translated to the appropriate quarterly or bi-annual files. These are then downloaded as single files, and thus the following call</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="kw"><a href="../reference/dl_bikedata.html">dl_bikedata</a></span> (<span class="dt">city =</span> <span class="st">'dc'</span>, <span class="dt">dates =</span> <span class="st">'2016.03-2016.05'</span>)</a></code></pre></div>
<p>will actually download data for the entire first and second quarters of 2016. Even though the database constructed with <code><a href="../reference/store_bikedata.html">store_bikedata()</a></code> will then contain data beyond the specified date ranges, it is nevertheless possible to obtain a trip matrix corresponding to specific dates and/or times, as described below.</p>
<p>The <code>dates</code> argument can also be passed to <code>store_bikedata</code>. This is useful in cases where data are to be loaded only from a restricted set of files in the given data directory.</p>
</div>
<div id="refreshing-data-sources" class="section level2">
<h2 class="hasAnchor">
<a href="#refreshing-data-sources" class="anchor"></a>3.2 Refreshing data sources</h2>
<p>The <code><a href="../reference/dl_bikedata.html">dl_bikedata()</a></code> function will only download data that do not already exist in the nominated directory, and so can be use to periodically refresh data. If, for example, the following function were previously run at the end of 2017:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="kw"><a href="../reference/dl_bikedata.html">dl_bikedata</a></span> (<span class="dt">city =</span> <span class="st">'sf'</span>, <span class="dt">data_dir =</span> <span class="st">'/data/stored/here'</span>)</a></code></pre></div>
<p>then running again in, say, April 2018, would download three additional files corresponding to the first three months of 2018. These data can then be added to a previously-constructed database with the usual call</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="kw"><a href="../reference/store_bikedata.html">store_bikedata</a></span> (<span class="dt">city =</span> <span class="st">'sf'</span>, <span class="dt">data_dir =</span> <span class="st">'/data/stored/here'</span>, <span class="dt">bikedb =</span> bikedb)</a></code></pre></div>
<p>If previous data have been stored in a nominated database, yet deleted from local storage, then any new data can be added by first getting the names of previously stored files with</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="kw"><a href="../reference/bike_stored_files.html">bike_stored_files</a></span> (<span class="dt">bikedb =</span> <span class="dt">bikedb =</span> <span class="dt">city =</span> <span class="st">'sf'</span>)</a></code></pre></div>
<p>And then calling <code>dl_bikedata</code>, with <code>dates</code> specified to add only those files not previously stored.</p>
</div>
<div id="storing-data" class="section level2">
<h2 class="hasAnchor">
<a href="#storing-data" class="anchor"></a>4. Storing Data</h2>
<p>As mentioned above, individual trip data are stored in a single <code>SQLite3</code> database, created by default in the temporary directory of the current <code>R</code> session. Specifying a path for the <code>bikedb</code> argument in the <code><a href="../reference/store_bikedata.html">store_bikedata()</a></code> function will create a database that will remain in that location until explicitly deleted.</p>
<p>The nominated database is created if it does not already exist, otherwise additional data are appended to the existing database. As described above, the same <code>dates</code> argument can be passed to both <code><a href="../reference/dl_bikedata.html">dl_bikedata()</a></code> and <code><a href="../reference/store_bikedata.html">store_bikedata()</a></code> to download data within specified ranges of dates.</p>
<p>Both <code><a href="../reference/dl_bikedata.html">dl_bikedata()</a></code> and <code><a href="../reference/store_bikedata.html">store_bikedata()</a></code> are primarily intended to be used to download data for specified cities. It is possible to use the latter to store all data for all cities simply by calling <code><a href="../reference/store_bikedata.html">store_bikedata (bikedb = bikedb)</a></code>, however doing so will request confirmation that data from <em>all</em> cities really ought to be downloaded and/or stored. Intended general usage of the <code><a href="../reference/store_bikedata.html">store_bikedata()</a></code> function is illustrated in the following line:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="kw"><a href="../reference/dl_bikedata.html">dl_bikedata</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">city =</span> <span class="st">'ny'</span>, <span class="dt">dates =</span> <span class="st">'2014 aug - 2015 dec'</span>)</a>
<a class="sourceLine" id="cb30-2" data-line-number="2">ntrips &lt;-<span class="st"> </span><span class="kw"><a href="../reference/store_bikedata.html">store_bikedata</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">city =</span> <span class="st">'ny'</span>,</a>
<a class="sourceLine" id="cb30-3" data-line-number="3">                          <span class="dt">data_dir =</span> <span class="st">'/data/stored/here'</span>)</a></code></pre></div>
<p>Note that passing with <code>city</code> parameter to <code><a href="../reference/store_bikedata.html">store_bikedata()</a></code> is not strictly necessary, but will ensure that only data for the nominated city are loaded from directories which may contain additional data from other cities.</p>
</div>
<div id="accessing-aggregate-data" class="section level2">
<h2 class="hasAnchor">
<a href="#accessing-aggregate-data" class="anchor"></a>5. Accessing Aggregate Data</h2>
<div id="origin-destination-matrices" class="section level3">
<h3 class="hasAnchor">
<a href="#origin-destination-matrices" class="anchor"></a>5.1 Origin-Destination Matrices</h3>
<p>As briefly described in the introduction, the primary function for extracting aggregate data from the <code>SQLite3</code> database established with <code><a href="../reference/store_bikedata.html">store_bikedata()</a></code> is <code><a href="../reference/bike_tripmat.html">bike_tripmat()</a></code>. With the single mandatory argument naming the database, this function returns a matrix of numbers of trips between all pairs of stations. Trip matrices can be returned either in square form (the default), with both rows and columns named after the bicycle docking stations and matrix entries tallying numbers of rides between each pair of stations, or in long form by requesting <code><a href="../reference/bike_tripmat.html">bike_tripmat (..., long = TRUE)</a></code>. The latter case will return a <a href="https://cran.r-project.org/package=tibble"><code>tibble</code></a> with the three columns of <code>station_station_id</code>, <code>end_station_id</code>, and <code>number_trips</code>, as demonstrated above.</p>
<p>The data for the individual stations associated with the trip matrix can be extracted with <code><a href="../reference/bike_stations.html">bike_stations()</a></code>, which returns a <code>tibble</code> containing the 6 columns of city, station code, station name, longitude, and latitude. Station codes are specified by the operators of each system, and pre-pended with a 2-character city identifier (so, for example, the first of the stations shown above is <code>la3005</code>). The <code><a href="../reference/bike_stations.html">bike_stations()</a></code> function will generally return all operational stations within a given system, which <code><a href="../reference/bike_tripmat.html">bike_tripmat()</a></code> will return only those stations in operation during the requested time period. The previous call stored all data from Chicago’s Divvybikes system for the year 2016 only, so the trip matrix has less entries than the full stations table, which includes stations added since then.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="kw">dim</span> (<span class="kw"><a href="../reference/bike_tripmat.html">bike_tripmat</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">city =</span> <span class="st">'ch'</span>))</a></code></pre></div>
<pre><code>## [1] 581 581</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="kw">dim</span> (<span class="kw"><a href="../reference/bike_stations.html">bike_stations</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">city =</span> <span class="st">'ch'</span>))</a></code></pre></div>
<pre><code>## [1] 596   6</code></pre>
<div id="temporal-filtering-of-trip-matrices" class="section level4">
<h4 class="hasAnchor">
<a href="#temporal-filtering-of-trip-matrices" class="anchor"></a>5.1.1. Temporal filtering of trip matrices</h4>
<p>Trip matrices can also be extracted for particular dates, times, and days of the week, through specifying one or more of the optional arguments:</p>
<ol style="list-style-type: decimal">
<li><code>start_date</code></li>
<li><code>end_date</code></li>
<li><code>start_time</code></li>
<li><code>end_time</code></li>
<li><code>weekday</code></li>
</ol>
<p>Arguments may in all cases be specified in a range of possible formats as long as they are unambiguous, and as long as ‘larger’ units precede ‘smaller’ units (so years before months before days, and hours before minutes before seconds). Acceptable formats may be illustrated through specifying a list of arguments to be passed to <code><a href="../reference/bike_tripmat.html">bike_tripmat()</a></code>. This is done here through passing two lists to <code><a href="../reference/bike_tripmat.html">bike_tripmat()</a></code> via <code>do.call()</code>, enabling the second list (<code>args1</code>) to be subsequently modified.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1">args0 &lt;-<span class="st"> </span><span class="kw">list</span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">city =</span> <span class="st">'ny'</span>, args)</a>
<a class="sourceLine" id="cb35-2" data-line-number="2">args1 &lt;-<span class="st"> </span><span class="kw">list</span> (<span class="dt">start_date =</span> <span class="dv">16</span>, <span class="dt">end_time =</span> <span class="dv">12</span>, <span class="dt">weekday =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb35-3" data-line-number="3">tm &lt;-<span class="st"> </span><span class="kw">do.call</span> (bike_tripmat, <span class="kw">c</span> (args0, args1))</a></code></pre></div>
<p>In <code>args1</code>, a two-digit <code>start_date</code> (or <code>end_date</code>) is interpreted to represent a year, while a one- or two-digit <code>_time</code> is interpreted to represent an hour. A value of <code>end_time = 24</code> is interpreted as <code>end_time = '23:59:59'</code>, while a value of <code>_time = 0</code> is interpreted as <code>00:00:00</code>. The following further illustrate the variety of acceptable formats,</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1">args1 &lt;-<span class="st"> </span><span class="kw">list</span> (<span class="dt">start_date =</span> <span class="st">'2016 May'</span>, <span class="dt">end_time =</span> <span class="st">'12:39'</span>, <span class="dt">weekday =</span> <span class="dv">2</span><span class="op">:</span><span class="dv">6</span>)</a>
<a class="sourceLine" id="cb36-2" data-line-number="2">args1 &lt;-<span class="st"> </span><span class="kw">list</span> (<span class="dt">end_date =</span> <span class="dv">20160720</span>, <span class="dt">end_time =</span> <span class="dv">123915</span>, <span class="dt">weekday =</span> <span class="kw">c</span> (<span class="st">'mo'</span>, <span class="st">'we'</span>))</a>
<a class="sourceLine" id="cb36-3" data-line-number="3">args1 &lt;-<span class="st"> </span><span class="kw">list</span> (<span class="dt">end_date =</span> <span class="st">'2016-07-20'</span>, <span class="dt">end_time =</span> <span class="st">'12:39:15'</span>, <span class="dt">weekday =</span> <span class="dv">2</span><span class="op">:</span><span class="dv">6</span>)</a></code></pre></div>
<p>Both <code>_date</code> and <code>_time</code> arguments may be specified in either <code>character</code> or <code>numeric</code> forms; in the former case with arbitrary (or no) separators. Regardless of format, larger units must precede smaller units as explained above.</p>
<p>Weekdays may specified as characters, which must simply be unambiguous and (in admission of currently inadequate internationalisation) correspond to standard English names. Minimal character specifications are thus <code>'so', 'm', 'tu', 'w', 'th', 'f', 'sa'</code>. The value of <code>weekday = 1</code> denotes Sunday, so <code>weekdays = 2:6</code> denote the traditional working days, Monday to Friday, while weekends may be denoted with <code>weekdays = c ('sa', 'so')</code> or <code>weekdays = c (1, 7)</code>.</p>
</div>
<div id="demographic-filtering-of-trip-matrices" class="section level4">
<h4 class="hasAnchor">
<a href="#demographic-filtering-of-trip-matrices" class="anchor"></a>5.1.2. Demographic filtering of trip matrices</h4>
<p>As described at the outset, the bicycle hire systems of several cities provide additional demographic information including whether or not cyclists are registered with the system, and if so, additional information including birth years and genders. Note that the provision of such information is voluntary, and that no providers can or do guarantee the accuracy of their data.</p>
<p>Those systems which provide demographic information are listed with the function <code><a href="../reference/bike_demographic_data.html">bike_demographic_data()</a></code>, which also lists the nominal kinds of demographic data provided by the different systems.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="kw"><a href="../reference/bike_demographic_data.html">bike_demographic_data</a></span> ()</a></code></pre></div>
<pre><code>##    city     city_name      bike_system demographic_data
## 1    bo        Boston           Hubway             TRUE
## 2    ch       Chicago            Divvy             TRUE
## 3    dc Washington DC CapitalBikeShare            FALSE
## 4    gu   Guadalajara           mibici             TRUE
## 5    la   Los Angeles            Metro            FALSE
## 6    lo        London        Santander            FALSE
## 7    mo      Montreal             Bixi            FALSE
## 8    mn   Minneapolis         NiceRide             TRUE
## 9    ny      New York         Citibike             TRUE
## 10   ph  Philadelphia           Indego            FALSE
## 11   sf      Bay Area       FordGoBike             TRUE</code></pre>
<p>Data can then be filtered by demographic parameters with additional optional arguments to <code><a href="../reference/bike_tripmat.html">bike_tripmat()</a></code> of,</p>
<ol style="list-style-type: decimal">
<li>
<code>registered</code> (<code>TRUE/FALSE</code>, <code>'yes'/'no'</code>, 0/1)</li>
<li>
<code>birth_year</code> (as one or more four-digit numbers or character strings)</li>
<li>
<code>gender</code> (‘m/f/.’, ‘male/female/other’)</li>
</ol>
<p>Users are not required to specify genders, and any values of <code>gender</code> other than character strings beginning with either <code>f</code> or <code>m</code> (case-insensitive) will be interpreted to request non-specified or alternative values of gender. Note further than many systems offer a range of potential birth years starting from a default value of 1900, and there are consequently a significant number of cyclists who declare this as their birth year.</p>
<p>It is of course possible to combine all of these optional parameters in a single query. For example,</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1">tm &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bike_tripmat.html">bike_tripmat</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">city =</span> <span class="st">'ny'</span>, <span class="dt">start_date =</span> <span class="dv">2016</span>,</a>
<a class="sourceLine" id="cb39-2" data-line-number="2">        <span class="dt">start_time =</span> <span class="dv">9</span>, <span class="dt">end_time =</span> <span class="dv">24</span>, <span class="dt">weekday =</span> <span class="dv">2</span><span class="op">:</span><span class="dv">6</span>, <span class="dt">gender =</span> <span class="st">'xx'</span>, </a>
<a class="sourceLine" id="cb39-3" data-line-number="3">        <span class="dt">birth_year =</span> <span class="dv">1900</span><span class="op">:</span><span class="dv">1950</span>)</a></code></pre></div>
<p>The value of <code>gender = 'xx'</code> will be interpreted to request data from all members with nominal alternative genders. As demographic data are only given for registered users, the <code>registered</code> parameter is redundant in this query.</p>
</div>
<div id="standardising-trip-matrices-by-durations-of-operation" class="section level4">
<h4 class="hasAnchor">
<a href="#standardising-trip-matrices-by-durations-of-operation" class="anchor"></a>5.1.3. Standardising trip matrices by durations of operation</h4>
<p>Most bicycle hire systems have progressively expanded over time through ongoing addition of new docking stations. Total numbers of counts within a trip matrix will thus be generally less for more recently installed stations, and more for older stations. The <code><a href="../reference/bike_tripmat.html">bike_tripmat()</a></code> function has an option, <code>standardise = FALSE</code>. Setting <code>standardise = TRUE</code> allows trip matrices to be standardised for durations of station operation, so that numbers of trips between any pair of stations reflect what they would be if all stations had been in operation for the same duration.</p>
<p>Standardisation implements a linear scaling of total numbers of trips to and from each station according to total durations of operation, with counts in the final trip matrix scaled to have the same total number of trips as the original matrix. This standardisation has two immediate consequences:</p>
<ol style="list-style-type: decimal">
<li>Numbers of trips between any pair of stations will not necessarily be integer values, but are rounded for the sake of sanity to three digits, corresponding to the maximal likely precision attainable for daily differences in operating durations;</li>
<li>Trip numbers will generally not equal actual observed numbers. Counts for the longest operating durations will be lower than actually recorded, while counts for more recent stations will be greater than observed values.</li>
</ol>
<p>The <code>standardise</code> option nevertheless enables travel patterns between different (groups of) stations to be statistically compared in a way that is free of the potentially confounding influence of differing durations of operation.</p>
</div>
</div>
<div id="station-data" class="section level3">
<h3 class="hasAnchor">
<a href="#station-data" class="anchor"></a>5.2. Station Data</h3>
<p>Data on docking stations may be accessed with the function <code><a href="../reference/bike_stations.html">bike_stations()</a></code> as demonstrated above:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1"><span class="kw"><a href="../reference/bike_stations.html">bike_stations</a></span> (<span class="dt">bikedb =</span> bikedb)</a></code></pre></div>
<pre><code>## # A tibble: 660 x 6
##       id city  stn_id name  longitude latitude
##    &lt;int&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1     1 la    la3005 ""         34.0    -118.
##  2     2 la    la3006 ""         34.0    -118.
##  3     3 la    la3007 ""         34.1    -118.
##  4     4 la    la3008 ""         34.0    -118.
##  5     5 la    la3009 ""         34.0    -118.
##  6     6 la    la3010 ""         34.0    -118.
##  7     7 la    la3011 ""         34.0    -118.
##  8     8 la    la3013 ""         34.1    -118.
##  9     9 la    la3014 ""         34.1    -118.
## 10    10 la    la3016 ""         34.0    -118.
## # ... with 650 more rows</code></pre>
<p>This function returns a <a href="https://cran.r-project.org/package=tibble"><code>tibble</code></a> detailing the names and locations of all bicycle stations present in the database. Station data for specific cities may be extracted through specifying an additional <code>city</code> argument.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1"><span class="kw"><a href="../reference/bike_stations.html">bike_stations</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">city =</span> <span class="st">'ch'</span>)</a></code></pre></div>
<pre><code>## # A tibble: 596 x 6
##       id city  stn_id name                          longitude latitude
##    &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;                             &lt;dbl&gt;    &lt;dbl&gt;
##  1    67 ch    ch456  2112 W Peterson Ave               -87.7     42.0
##  2    68 ch    ch101  63rd St Beach                     -87.6     41.8
##  3    69 ch    ch109  900 W Harrison St                 -87.7     41.9
##  4    70 ch    ch21   Aberdeen St &amp; Jackson Blvd        -87.7     41.9
##  5    71 ch    ch80   Aberdeen St &amp; Monroe St           -87.7     41.9
##  6    72 ch    ch346  Ada St &amp; Washington Blvd          -87.7     41.9
##  7    73 ch    ch341  Adler Planetarium                 -87.6     41.9
##  8    74 ch    ch444  Albany Ave &amp; 26th St              -87.7     41.8
##  9    75 ch    ch511  Albany Ave &amp; Bloomingdale Ave     -87.7     41.9
## 10    76 ch    ch376  Artesian Ave &amp; Hubbard St         -87.7     41.9
## # ... with 586 more rows</code></pre>
</div>
<div id="summary-statistics" class="section level3">
<h3 class="hasAnchor">
<a href="#summary-statistics" class="anchor"></a>5.3. Summary Statistics</h3>
<p><code>bikedata</code> provides a number of helper functions for extracting summary statistics from the <code>SQLite3</code> database. The function <code><a href="../reference/bike_summary_stats.html">bike_summary_stats (bikedb)</a></code> generates an overview table. (This function may take some time to execute on large databases.)</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1"><span class="kw"><a href="../reference/bike_summary_stats.html">bike_summary_stats</a></span> (bikedb)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 6
##   city  num_trips num_stations first_trip      last_trip      latest_files
##   &lt;chr&gt;     &lt;dbl&gt;        &lt;dbl&gt; &lt;fct&gt;           &lt;fct&gt;          &lt;lgl&gt;       
## 1 total   3693521          662 2016-01-01 00:… 2016-12-31 23… NA          
## 2 ch      3595383          596 2016-01-01 00:… 2016-12-31 23… TRUE        
## 3 la        98138           66 2016-07-07 04:… 2016-12-31 23… TRUE</code></pre>
<p>Additional helper functions provide individual components from this summary data, and will generally do so notably faster for large databases than the above function. The primary individual function is <code><a href="../reference/bike_db_totals.html">bike_db_totals()</a></code>, which can be used to extract total numbers of either trips (the default) or stations (by specifying <code>trips = FALSE</code>) from the entire database or from specific cities.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1"><span class="kw"><a href="../reference/bike_db_totals.html">bike_db_totals</a></span> (<span class="dt">bikedb =</span> bikedb)</a></code></pre></div>
<pre><code>## [1] 3693521</code></pre>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" data-line-number="1"><span class="kw"><a href="../reference/bike_db_totals.html">bike_db_totals</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">city =</span> <span class="st">"ch"</span>)</a></code></pre></div>
<pre><code>## [1] 3595383</code></pre>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" data-line-number="1"><span class="kw"><a href="../reference/bike_db_totals.html">bike_db_totals</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">city =</span> <span class="st">"la"</span>)</a></code></pre></div>
<pre><code>## [1] 93138</code></pre>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb52-1" data-line-number="1"><span class="kw"><a href="../reference/bike_db_totals.html">bike_db_totals</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">trips =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>## [1] 660</code></pre>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb54-1" data-line-number="1"><span class="kw"><a href="../reference/bike_db_totals.html">bike_db_totals</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">trips =</span> <span class="ot">FALSE</span>, <span class="dt">city =</span> <span class="st">"ch"</span>)</a></code></pre></div>
<pre><code>## [1] 596</code></pre>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" data-line-number="1"><span class="kw"><a href="../reference/bike_db_totals.html">bike_db_totals</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">trips =</span> <span class="ot">FALSE</span>, <span class="dt">city =</span> <span class="st">"la"</span>)</a></code></pre></div>
<pre><code>## [1] 64</code></pre>
<p>The other primary components of <code><a href="../reference/bike_summary_stats.html">bike_summary_stats()</a></code> are the dates of first and last trips for the entire database and for individual cities. These dates can be obtained directly with the function <code><a href="../reference/bike_datelimits.html">bike_datelimits()</a></code>:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" data-line-number="1"><span class="kw"><a href="../reference/bike_datelimits.html">bike_datelimits</a></span> (<span class="dt">bikedb =</span> bikedb)</a></code></pre></div>
<pre><code>##                 first                  last 
## "2016-01-01 00:07:00" "2016-12-31 23:57:52"</code></pre>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" data-line-number="1"><span class="kw"><a href="../reference/bike_datelimits.html">bike_datelimits</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">city =</span> <span class="st">'ch'</span>)</a></code></pre></div>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" data-line-number="1"><span class="kw">c</span> (<span class="st">'first'</span> =<span class="st"> "2016-01-01 00:07:00"</span>, <span class="st">'last'</span> =<span class="st"> "2016-12-31 23:57:52"</span>)</a></code></pre></div>
<pre><code>##                 first                  last 
## "2016-01-01 00:07:00" "2016-12-31 23:57:52"</code></pre>
<p>A helper function is also provided to determine whether the files stored in the database represent the latest available files.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb63-1" data-line-number="1"><span class="kw"><a href="../reference/bike_latest_files.html">bike_latest_files</a></span> (<span class="dt">bikedb =</span> bikedb)</a></code></pre></div>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb64-1" data-line-number="1"><span class="kw">c</span> (<span class="st">'la'</span> =<span class="st"> </span><span class="ot">TRUE</span>, <span class="st">'ch'</span> =<span class="st"> </span><span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>##    la    ch 
##  TRUE FALSE</code></pre>
</div>
<div id="time-series-of-daily-trips" class="section level3">
<h3 class="hasAnchor">
<a href="#time-series-of-daily-trips" class="anchor"></a>5.4. Time Series of Daily Trips</h3>
<p>The <code><a href="../reference/bike_tripmat.html">bike_tripmat()</a></code> function provides a <em>spatial</em> aggregation of data. An equivalent <em>temporal</em> aggregation is provided by the function <code><a href="../reference/bike_daily_trips.html">bike_daily_trips()</a></code>, which aggregates trips for individual days.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb66-1" data-line-number="1"><span class="kw"><a href="../reference/bike_daily_trips.html">bike_daily_trips</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">city =</span> <span class="st">'ch'</span>)</a></code></pre></div>
<pre><code>## # A tibble: 366 x 2
##    date       numtrips
##    &lt;chr&gt;         &lt;dbl&gt;
##  1 2016-01-01      935
##  2 2016-01-02     1421
##  3 2016-01-03     1399
##  4 2016-01-04     3833
##  5 2016-01-05     4189
##  6 2016-01-06     4608
##  7 2016-01-07     5028
##  8 2016-01-08     3425
##  9 2016-01-09     1733
## 10 2016-01-10      993
## # ... with 356 more rows</code></pre>
<p>Daily trip counts can also be standardised to account for differences in numbers of stations within a system as for trip matrix standardisation described above. Such standardisation is helpful because daily numbers of trips will generally increase with increasing numbers of stations. Standardisation returns a time series of daily trips reflecting what they would be if all system stations had been in operation throughout the entire time.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb68-1" data-line-number="1"><span class="kw"><a href="../reference/bike_daily_trips.html">bike_daily_trips</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">city =</span> <span class="st">'ch'</span>, <span class="dt">standardise =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## # A tibble: 366 x 2
##    date       numtrips
##    &lt;chr&gt;         &lt;dbl&gt;
##  1 2016-01-01    2469.
##  2 2016-01-02    2482.
##  3 2016-01-03    2201.
##  4 2016-01-04    5510.
##  5 2016-01-05    5884.
##  6 2016-01-06    6298.
##  7 2016-01-07    6630.
##  8 2016-01-08    4476.
##  9 2016-01-09    2265.
## 10 2016-01-10    1298.
## # ... with 356 more rows</code></pre>
<p>This <a href="https://cran.r-project.org/package=tibble"><code>tibble</code></a> reveals two points of immediate note:</p>
<ol style="list-style-type: decimal">
<li>Trip numbers are no longer integer values, but are rounded to three decimal places to reflect the highest plausible numerical accuracy; and</li>
<li>Standardised trip numbers are considerably higher for the initial values, because of expansion of the Chicago Divvy system throughout the year 2016.</li>
</ol>
</div>
</div>
<div id="direct-database-access" class="section level2">
<h2 class="hasAnchor">
<a href="#direct-database-access" class="anchor"></a>6. Direct database access</h2>
<p>Although the <code>bikedata</code> package aims to circumvent any need to access the database directly, through providing ready extraction of trip data for most analytical or visualisation needs, direct access may be achieved either using the convenient <code>dplyr</code> functions, or the more powerful functionality provided by the <code>RSQLite</code> package.</p>
<p>The following code illustrates access using the <code>dplyr</code> package:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb70-1" data-line-number="1">db &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/src_dbi.html">src_sqlite</a></span> (bikedb, <span class="dt">create=</span>F)</a>
<a class="sourceLine" id="cb70-2" data-line-number="2">dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/src_tbls.html">src_tbls</a></span> (db)</a></code></pre></div>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb71-1" data-line-number="1"><span class="kw">c</span> (<span class="st">"datafiles"</span>, <span class="st">"stations"</span>, <span class="st">"trips"</span>)</a></code></pre></div>
<pre><code>## [1] "datafiles" "stations"  "trips"</code></pre>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb73-1" data-line-number="1">dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/compute.html">collect</a></span> (dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span> (db, <span class="st">'datafiles'</span>))</a></code></pre></div>
<pre><code>## # A tibble: 5 x 3
##      id city  name                            
##   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;                           
## 1     0 la    la_metro_gbfs_trips_Q1_2017.zip 
## 2     1 la    MetroBikeShare_2016_Q3_trips.zip
## 3     2 la    Metro_trips_Q4_2016.zip         
## 4     3 ch    Divvy_Trips_2016_Q1Q2.zip       
## 5     4 ch    Divvy_Trips_2016_Q3Q4.zip</code></pre>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" data-line-number="1">dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/compute.html">collect</a></span> (dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span> (db, <span class="st">'stations'</span>))</a></code></pre></div>
<pre><code>## # A tibble: 660 x 6
##       id city  stn_id name  longitude latitude
##    &lt;int&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1     1 la    la3005 ""         34.0    -118.
##  2     2 la    la3006 ""         34.0    -118.
##  3     3 la    la3007 ""         34.1    -118.
##  4     4 la    la3008 ""         34.0    -118.
##  5     5 la    la3009 ""         34.0    -118.
##  6     6 la    la3010 ""         34.0    -118.
##  7     7 la    la3011 ""         34.0    -118.
##  8     8 la    la3013 ""         34.1    -118.
##  9     9 la    la3014 ""         34.1    -118.
## 10    10 la    la3016 ""         34.0    -118.
## # ... with 650 more rows</code></pre>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb77-1" data-line-number="1">dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/compute.html">collect</a></span> (dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span> (db, <span class="st">'trips'</span>))</a></code></pre></div>
<pre><code>## # A tibble: 3,693,511 x 11
##       id city  trip_duration start_time stop_time start_station_id
##    &lt;int&gt; &lt;chr&gt;         &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;     &lt;chr&gt;           
##  1     1 la              180 2016-01-0… 2017-01-… a               
##  2     2 la             1980 2016-01-0… 2017-01-… a               
##  3     3 la              300 2016-01-0… 2017-01-… a               
##  4     4 la            10860 2016-01-0… 2017-01-… a               
##  5     5 la              420 2016-01-0… 2017-01-… a               
##  6     6 la              780 2016-01-0… 2017-01-… a               
##  7     7 la              600 2016-01-0… 2017-01-… a               
##  8     8 la              600 2016-01-0… 2017-01-… a               
##  9     9 la             2880 2016-01-0… 2017-01-… a               
## 10    10 la              960 2016-01-0… 2017-01-… a               
## # ... with 3,693,501 more rows, and 5 more variables:
## #   end_station_id &lt;chr&gt;, bike_id &lt;chr&gt;, user_type &lt;chr&gt;,
## #   birth_year &lt;int&gt;, gender &lt;int&gt;</code></pre>
<p>The <a href="https://cran.r-project.org/package=RSQLite"><code>RSQLite</code></a> package enables more complex queries to be constructed. The names of stations, for example, could be extracted using the following code</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb79-1" data-line-number="1">db &lt;-<span class="st"> </span>RSQLite<span class="op">::</span><span class="kw">dbConnect</span>(RSQLite<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/RSQLite/topics/SQLite">SQLite</a></span>(), bikedb, <span class="dt">create =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb79-2" data-line-number="2">qry &lt;-<span class="st"> "SELECT stn_id, name FROM stations WHERE city = 'ch'"</span></a>
<a class="sourceLine" id="cb79-3" data-line-number="3">stns &lt;-<span class="st"> </span>RSQLite<span class="op">::</span><span class="kw">dbGetQuery</span>(db, qry)</a>
<a class="sourceLine" id="cb79-4" data-line-number="4">RSQLite<span class="op">::</span><span class="kw">dbDisconnect</span>(db)</a>
<a class="sourceLine" id="cb79-5" data-line-number="5"><span class="kw">head</span> (stns)</a></code></pre></div>
<pre><code>##   stn_id                       name
## 1  ch456        2112 W Peterson Ave
## 2  ch101              63rd St Beach
## 3  ch109          900 W Harrison St
## 4   ch21 Aberdeen St &amp; Jackson Blvd
## 5   ch80    Aberdeen St &amp; Monroe St
## 6  ch346   Ada St &amp; Washington Blvd</code></pre>
<p>Many of the queries used in the <code>bikedata</code> package are constructed in this way using the <code>RSQLite</code> interface.</p>
</div>
<div id="visualisation-of-bicycle-trips" class="section level2">
<h2 class="hasAnchor">
<a href="#visualisation-of-bicycle-trips" class="anchor"></a>7. Visualisation of bicycle trips</h2>
<p>The <code>bikedata</code> package does not provide any functions enabling visualisation of aggregate trip data, both because of the primary focus on enabling access and aggregation in the simplest practicable way, and because of the myriad different ways users of the package are likely to want to visualise the data. This section therefore relies on other packages to illustrate some of the ways in which trip matrices may be visualised.</p>
<div id="visualisation-using-r-base-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#visualisation-using-r-base-functions" class="anchor"></a>7.1 Visualisation using R Base functions</h3>
<p>The simplest spatial visualisation involves connecting the geographical coordinates of stations with straight lines, with numbers of trips represented by some characteristics of the lines connecting pairs of stations, such as thickness or colours. This can be achieved with the following code, which also illustrates that it is generally more useful for visualisation purposes to extract trip matrices in long rather than square form.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb81-1" data-line-number="1">stns &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bike_stations.html">bike_stations</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">city =</span> <span class="st">'la'</span>)</a>
<a class="sourceLine" id="cb81-2" data-line-number="2">ntrips &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bike_tripmat.html">bike_tripmat</a></span> (<span class="dt">bikedb =</span> bikedb, <span class="dt">city =</span> <span class="st">'la'</span>, <span class="dt">long =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb81-3" data-line-number="3">x1 &lt;-<span class="st"> </span>stns<span class="op">$</span>longitude [<span class="kw">match</span> (ntrips<span class="op">$</span>start_station_id, stns<span class="op">$</span>stn_id)]</a>
<a class="sourceLine" id="cb81-4" data-line-number="4">y1 &lt;-<span class="st"> </span>stns<span class="op">$</span>latitude [<span class="kw">match</span> (ntrips<span class="op">$</span>start_station_id, stns<span class="op">$</span>stn_id)]</a>
<a class="sourceLine" id="cb81-5" data-line-number="5">x2 &lt;-<span class="st"> </span>stns<span class="op">$</span>longitude [<span class="kw">match</span> (ntrips<span class="op">$</span>end_station_id, stns<span class="op">$</span>stn_id)]</a>
<a class="sourceLine" id="cb81-6" data-line-number="6">y2 &lt;-<span class="st"> </span>stns<span class="op">$</span>latitude [<span class="kw">match</span> (ntrips<span class="op">$</span>end_station_id, stns<span class="op">$</span>stn_id)]</a>
<a class="sourceLine" id="cb81-7" data-line-number="7"><span class="co"># Set plot area to central region of bike system</span></a>
<a class="sourceLine" id="cb81-8" data-line-number="8">xlims &lt;-<span class="st"> </span><span class="kw">c</span> (<span class="op">-</span><span class="fl">118.27</span>, <span class="fl">-118.23</span>)</a>
<a class="sourceLine" id="cb81-9" data-line-number="9">ylims &lt;-<span class="st"> </span><span class="kw">c</span> (<span class="fl">34.02</span>, <span class="fl">34.07</span>)</a>
<a class="sourceLine" id="cb81-10" data-line-number="10"><span class="kw">plot</span> (stns<span class="op">$</span>longitude, stns<span class="op">$</span>latitude, <span class="dt">xlim =</span> xlims, <span class="dt">ylim =</span> ylims)</a>
<a class="sourceLine" id="cb81-11" data-line-number="11">cols &lt;-<span class="st"> </span><span class="kw">rainbow</span> (<span class="dv">100</span>)</a>
<a class="sourceLine" id="cb81-12" data-line-number="12">nt &lt;-<span class="st"> </span><span class="kw">ceiling</span> (ntrips<span class="op">$</span>numtrips <span class="op">*</span><span class="st"> </span><span class="dv">100</span> <span class="op">/</span><span class="st"> </span><span class="kw">max</span> (ntrips<span class="op">$</span>numtrips))</a>
<a class="sourceLine" id="cb81-13" data-line-number="13"><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq</span> (x1))</a>
<a class="sourceLine" id="cb81-14" data-line-number="14">    <span class="kw">lines</span> (<span class="kw">c</span> (x1 [i], x2 [i]), <span class="kw">c</span> (y1 [i], y2 [i]), <span class="dt">col =</span> cols [nt [i]],</a>
<a class="sourceLine" id="cb81-15" data-line-number="15">        <span class="dt">lwd =</span> ntrips<span class="op">$</span>numtrips [i] <span class="op">*</span><span class="st"> </span><span class="dv">10</span> <span class="op">/</span><span class="st"> </span><span class="kw">max</span> (ntrips<span class="op">$</span>numtrips))</a></code></pre></div>
<p><img src="la_map_simple.png"></p>
</div>
<div id="a-more-sophisticated-visualisation" class="section level3">
<h3 class="hasAnchor">
<a href="#a-more-sophisticated-visualisation" class="anchor"></a>7.2 A More Sophisticated Visualisation</h3>
<p>The following code illustrates a more sophisticated approach to plotting such data, using routines from the packages <code>osmdata</code>, <code>stplanr</code>, and <code>tmap</code>. Begin by extracting the street network for Los Angeles using the <code>osmdata</code> package. Current <code>stplanr</code> routines require spatial objects of class <a href="https://cran.r-project.org/package=sp"><code>sp</code></a> rather than <a href="https://cran.r-project.org/package=sf"><code>sf</code></a>.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb82-1" data-line-number="1"><span class="kw">library</span> (magrittr)</a>
<a class="sourceLine" id="cb82-2" data-line-number="2">xlims_la &lt;-<span class="st"> </span><span class="kw">range</span> (stns<span class="op">$</span>longitude, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb82-3" data-line-number="3">ylims_la &lt;-<span class="st"> </span><span class="kw">range</span> (stns<span class="op">$</span>latitude, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb82-4" data-line-number="4"><span class="co"># expand those limits slightly</span></a>
<a class="sourceLine" id="cb82-5" data-line-number="5">ex &lt;-<span class="st"> </span><span class="fl">0.1</span></a>
<a class="sourceLine" id="cb82-6" data-line-number="6">xlims_la &lt;-<span class="st"> </span>xlims_la <span class="op">+</span><span class="st"> </span><span class="kw">c</span> (<span class="op">-</span>ex, ex) <span class="op">*</span><span class="st"> </span><span class="kw">diff</span> (xlims_la)</a>
<a class="sourceLine" id="cb82-7" data-line-number="7">ylims_la &lt;-<span class="st"> </span>ylims_la <span class="op">+</span><span class="st"> </span><span class="kw">c</span> (<span class="op">-</span>ex, ex) <span class="op">*</span><span class="st"> </span><span class="kw">diff</span> (ylims_la)</a>
<a class="sourceLine" id="cb82-8" data-line-number="8">bbox &lt;-<span class="st"> </span><span class="kw">c</span> (xlims_la [<span class="dv">1</span>], ylims_la [<span class="dv">1</span>], xlims_la [<span class="dv">2</span>], ylims_la [<span class="dv">2</span>])</a>
<a class="sourceLine" id="cb82-9" data-line-number="9">bbox &lt;-<span class="st"> </span><span class="kw">c</span> (xlims [<span class="dv">1</span>], xlims [<span class="dv">2</span>], ylims [<span class="dv">1</span>], ylims [<span class="dv">2</span>])</a>
<a class="sourceLine" id="cb82-10" data-line-number="10"><span class="co"># Then the actual osmdata query to extract all OpenStreetMap highways</span></a>
<a class="sourceLine" id="cb82-11" data-line-number="11">highways &lt;-<span class="st"> </span>osmdata<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/osmdata/topics/opq">opq</a></span> (<span class="dt">bbox =</span> bbox) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb82-12" data-line-number="12"><span class="st">    </span>osmdata<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/osmdata/topics/add_osm_feature">add_osm_feature</a></span> (<span class="dt">key =</span> <span class="st">'highway'</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb82-13" data-line-number="13"><span class="st">    </span>osmdata<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/osmdata/topics/osmdata_sp">osmdata_sp</a></span> (<span class="dt">quiet =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p>For compatibility with current <code>stplanr</code> code, the <code>stns</code> table also needs to be converted to a <code>SpatialPointsDataFrame</code> and re-projected.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb83-1" data-line-number="1">stns_tbl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bike_stations.html">bike_stations</a></span> (<span class="dt">bikedb =</span> bikedb)</a>
<a class="sourceLine" id="cb83-2" data-line-number="2">stns &lt;-<span class="st"> </span>sp<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/sp/topics/SpatialPoints">SpatialPointsDataFrame</a></span> (<span class="dt">coords =</span> stns_tbl[,<span class="kw">c</span>(<span class="st">'longitude'</span>,<span class="st">'latitude'</span>)],</a>
<a class="sourceLine" id="cb83-3" data-line-number="3">                                    <span class="dt">proj4string =</span> sp<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/sp/topics/CRS-class">CRS</a></span>(<span class="st">"+init=epsg:4326"</span>), </a>
<a class="sourceLine" id="cb83-4" data-line-number="4">                                    <span class="dt">data =</span> stns_tbl)</a>
<a class="sourceLine" id="cb83-5" data-line-number="5">stns &lt;-<span class="st"> </span>sp<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/sp/topics/spTransform">spTransform</a></span> (stns, highways<span class="op">$</span>osm_lines<span class="op">@</span>proj4string)</a></code></pre></div>
<p>These data can then be used to create an <code><a href="http://www.rdocumentation.org/packages/stplanr/topics/SpatialLinesNetwork">stplanr::SpatialLinesNetwork</a></code> which can be used to trace the routes between bicycle stations along the street network. This first requires mapping the bicycle station locations to the nearest nodes in the street network, and converting the start and end stations of the <code>ntrips</code> table to corresponding rows in the street network data frame.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb84-1" data-line-number="1">la_net &lt;-<span class="st"> </span>stplanr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/stplanr/topics/SpatialLinesNetwork">SpatialLinesNetwork</a></span> (<span class="dt">sl =</span> highways<span class="op">$</span>osm_lines)</a>
<a class="sourceLine" id="cb84-2" data-line-number="2"><span class="co"># Find the closest node to each station</span></a>
<a class="sourceLine" id="cb84-3" data-line-number="3">nodeid &lt;-<span class="st"> </span>stplanr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/stplanr/topics/find_network_nodes">find_network_nodes</a></span> (la_net, stns<span class="op">$</span>longitude, stns<span class="op">$</span>latitude)</a>
<a class="sourceLine" id="cb84-4" data-line-number="4"><span class="co"># Convert start and end station IDs in trips table to node IDs in `la_net`</span></a>
<a class="sourceLine" id="cb84-5" data-line-number="5">startid &lt;-<span class="st"> </span>nodeid [<span class="kw">match</span> (ntrips<span class="op">$</span>start_station_id, stns<span class="op">$</span>stn_id)]</a>
<a class="sourceLine" id="cb84-6" data-line-number="6">endid &lt;-<span class="st"> </span>nodeid [<span class="kw">match</span> (ntrips<span class="op">$</span>end_station_id, stns<span class="op">$</span>stn_id)]</a>
<a class="sourceLine" id="cb84-7" data-line-number="7">ntrips<span class="op">$</span>start_station_id &lt;-<span class="st"> </span>startid</a>
<a class="sourceLine" id="cb84-8" data-line-number="8">ntrips<span class="op">$</span>end_station_id &lt;-<span class="st"> </span>endid</a></code></pre></div>
<p>The aggregate trips on each part of the network using the <code>sum_network_lines()</code> function which is part of the current development version of <code>stplanr</code>.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb85-1" data-line-number="1">bike_usage &lt;-<span class="st"> </span>stplanr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/stplanr/topics/sum_network_links">sum_network_links</a></span> (la_net, <span class="kw">data.frame</span> (ntrips))</a></code></pre></div>
<p>Then finally plot it with <code>tmap</code>, again trimming the plot using the previous limits to exclude a very few isolated stations</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb86-1" data-line-number="1">tmap<span class="op">::</span><span class="kw">tm_shape</span> (bike_usage, <span class="dt">xlim =</span> xlims, <span class="dt">ylim =</span> ylims, <span class="dt">is.master=</span><span class="ot">TRUE</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb86-2" data-line-number="2"><span class="st">    </span>tmap<span class="op">::</span><span class="kw">tm_lines</span> (<span class="dt">col=</span><span class="st">"numtrips"</span>, <span class="dt">lwd=</span><span class="st">"numtrips"</span>, <span class="dt">title.col =</span> <span class="st">"Number of trips"</span>,</a>
<a class="sourceLine" id="cb86-3" data-line-number="3">                    <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">200</span>, <span class="dv">400</span>, <span class="dv">600</span>, <span class="dv">800</span>, <span class="dv">1000</span>, <span class="ot">Inf</span>),</a>
<a class="sourceLine" id="cb86-4" data-line-number="4">                    <span class="dt">legend.lwd.show =</span> <span class="ot">FALSE</span>, <span class="dt">scale =</span> <span class="dv">5</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb86-5" data-line-number="5"><span class="st">    </span>tmap<span class="op">::</span><span class="kw">tm_layout</span> (<span class="dt">bg.color=</span><span class="st">"gray95"</span>, <span class="dt">legend.position =</span> <span class="kw">c</span> (<span class="st">"right"</span>, <span class="st">"bottom"</span>),</a>
<a class="sourceLine" id="cb86-6" data-line-number="6">                     <span class="dt">legend.bg.color =</span> <span class="st">"white"</span>, <span class="dt">legend.bg.alpha =</span> <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb86-7" data-line-number="7"><span class="co">#tmap::save_tmap (filename = "la_map.png")</span></a></code></pre></div>
<p><img src="la_map.png"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">1. Introduction</a></li>
      <li><a href="#main-functions">2. Main Functions</a></li>
      <li><a href="#downloading-data">3. Downloading Data</a></li>
      <li><a href="#downloading-data-for-specific-date-ranges">3.1 Downloading data for specific date ranges</a></li>
      <li><a href="#refreshing-data-sources">3.2 Refreshing data sources</a></li>
      <li><a href="#storing-data">4. Storing Data</a></li>
      <li><a href="#accessing-aggregate-data">5. Accessing Aggregate Data</a></li>
      <li><a href="#direct-database-access">6. Direct database access</a></li>
      <li><a href="#visualisation-of-bicycle-trips">7. Visualisation of bicycle trips</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Mark Padgham, Richard Ellison, Tom Buckley.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
